{% extends "base.html" %}
{% block content %}

<h1 class="mb-3">Admin Dashboard</h1>

<p class="text-muted mb-4">
  You are logged in as <strong>{{ current_user.email }}</strong>.
  This page is visible only to admin users.
</p>

<div class="row mb-4 g-3">
  <!-- Total users -->
  <div class="col-md-3">
    <div class="card border-primary h-100">
      <div class="card-body">
        <h5 class="card-title">Users</h5>
        <p class="display-6 mb-0">{{ total_users }}</p>
        <small class="text-muted">Total registered accounts</small>
      </div>
    </div>
  </div>

  <!-- Estimated AI cost this month -->
  <div class="col-md-3">
    <div class="card border-danger h-100">
      <div class="card-body">
        <h5 class="card-title">AI Cost (est.)</h5>
        <p class="display-6 mb-0">
          ${{ "%.4f"|format(total_estimated_cost) }}
        </p>
        <small class="text-muted">
          Based on monthly input/output tokens
        </small>
      </div>
    </div>
  </div>

  <!-- Estimated revenue this month (only non-admin paid plans) -->
  <div class="col-md-3">
    <div class="card border-success h-100">
      <div class="card-body">
        <h5 class="card-title">Revenue (est.)</h5>
        <p class="display-6 mb-0">
          ${{ "%.2f"|format(total_estimated_revenue) }}
        </p>
        <small class="text-muted">
          Sum of plan prices (basic/premium/professional)
        </small>
      </div>
    </div>
  </div>

  <!-- Net profit this month -->
  <div class="col-md-3">
    <div class="card border-info h-100">
      <div class="card-body">
        <h5 class="card-title">Net (est.)</h5>
        <p class="display-6 mb-0">
          ${{ "%.2f"|format(net_estimated_profit) }}
        </p>
        <small class="text-muted">
          Revenue − AI cost
        </small>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4 g-3">
  <!-- Token usage summary -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Token Usage (All Users)</h5>
        <p class="mb-1">
          <strong>Daily:</strong>
          {{ total_daily_input_tokens }} in /
          {{ total_daily_output_tokens }} out
        </p>
        <p class="mb-1">
          <strong>Monthly:</strong>
          {{ total_monthly_input_tokens }} in /
          {{ total_monthly_output_tokens }} out
        </p>
        <small class="text-muted">
          Input rate: ${{ "%.8f"|format(input_token_rate) }} per token,
          Output rate: ${{ "%.8f"|format(output_token_rate) }} per token
        </small>
      </div>
    </div>
  </div>

  <!-- Cards this month summary -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Cards Generated (This Month)</h5>
        <p class="display-6 mb-0">{{ total_monthly_cards }}</p>
        <small class="text-muted">
          Sum of all users' cards_generated_this_month
        </small>
      </div>
    </div>
  </div>

  <!-- Plans overview -->
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title mb-3">Plans Overview</h5>
        <div class="row">
          <div class="col-6 col-lg-6 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span>Free</span>
              <span class="badge bg-secondary">
                {{ plan_counts.get('free', 0) }}
              </span>
            </div>
            <small class="text-muted">
              Limit: {{ plan_limits['free'] }} / day
            </small>
          </div>
          <div class="col-6 col-lg-6 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span>Basic</span>
              <span class="badge bg-info text-dark">
                {{ plan_counts.get('basic', 0) }}
              </span>
            </div>
            <small class="text-muted">
              Limit: {{ plan_limits['basic'] }} / day
            </small>
          </div>
          <div class="col-6 col-lg-6 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span>Premium</span>
              <span class="badge bg-primary">
                {{ plan_counts.get('premium', 0) }}
              </span>
            </div>
            <small class="text-muted">
              Limit: {{ plan_limits['premium'] }} / day
            </small>
          </div>
          <div class="col-6 col-lg-6 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span>Professional</span>
              <span class="badge bg-dark">
                {{ plan_counts.get('professional', 0) }}
              </span>
            </div>
            <small class="text-muted">
              Limit: {{ plan_limits['professional'] }} / day
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<hr class="mb-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Users</h4>
  <a href="{{ url_for('views.admin_analytics') }}" class="btn btn-outline-primary btn-sm">
    View Analytics
  </a>
</div>

<div class="table-responsive">
  <table class="table table-sm table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col">Email</th>
        <th scope="col">Plan</th>
        <th scope="col">Daily Usage</th>
        <th scope="col">Cards This Month</th>
        <th scope="col">Tokens</th>
        <th scope="col">Cost & Revenue</th>
        <th scope="col">Stripe</th>
        <th scope="col">Created</th>
        <th scope="col">Admin</th>
      </tr>
    </thead>
    <tbody>
      {% for row in user_rows %}
        {% set u = row.user %}
        <tr>
          <!-- Email -->
          <td>
            {{ u.email }}
            {% if u.id == current_user.id %}
              <span class="badge bg-secondary ms-1">You</span>
            {% endif %}
          </td>

          <!-- Plan -->
          <td>
            {% if row.plan == 'free' %}
              <span class="badge bg-secondary">Free</span>
            {% elif row.plan == 'basic' %}
              <span class="badge bg-info text-dark">Basic</span>
            {% elif row.plan == 'premium' %}
              <span class="badge bg-primary">Premium</span>
            {% elif row.plan == 'professional' %}
              <span class="badge bg-dark">Professional</span>
            {% else %}
              <span class="badge bg-light text-dark">
                {{ row.plan|capitalize }}
              </span>
            {% endif %}
          </td>

          <!-- Daily usage -->
          <td>
            <div>
              {{ row.daily_used }} / {{ row.daily_limit }}
            </div>
            <small class="text-muted">
              Remaining: {{ row.daily_remaining }}
            </small>
          </td>

          <!-- Cards this month (analytics only) -->
          <td>
            <strong>{{ row.monthly_cards }}</strong>
            <br>
            <small class="text-muted">Generated this month</small>
          </td>

          <!-- Tokens -->
          <td>
            <div>
              <small>
                Daily:
                {{ row.daily_input_tokens }} in /
                {{ row.daily_output_tokens }} out
              </small>
            </div>
            <div>
              <small>
                Monthly:
                {{ row.monthly_input_tokens }} in /
                {{ row.monthly_output_tokens }} out
              </small>
            </div>
          </td>

          <!-- Cost & revenue -->
          <td>
            <div>
              <small>Cost (est.):</small>
              <br>
              <span class="text-danger">
                ${{ "%.5f"|format(row.estimated_cost) }}
              </span>
            </div>
            <div class="mt-1">
              <small>Revenue (est.):</small>
              <br>
              <span class="text-success">
                ${{ "%.2f"|format(row.estimated_revenue) }}
              </span>
            </div>
          </td>

          <!-- Stripe link status -->
          <td>
            {% if u.stripe_customer_id %}
              <span class="badge bg-success">Linked</span>
              <br>
              <small class="text-muted">
                {{ u.stripe_price_id or 'No price' }}
              </small>
            {% else %}
              <span class="badge bg-outline-secondary border">
                None
              </span>
            {% endif %}
          </td>

          <!-- Created at -->
          <td>
            {{ u.created_at.strftime("%Y-%m-%d") if u.created_at else "—" }}
          </td>

          <!-- Admin flag -->
          <td>
            {% if u.is_admin %}
              <span class="badge bg-warning text-dark">Admin</span>
            {% else %}
              <span class="text-muted">No</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}
